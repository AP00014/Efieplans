import{j as e,Z as R,_ as L,$ as Z,a0 as H,X as J,b as y,a1 as O,a2 as W}from"./ui-vendor-DzdBeN5K.js";import{d as X,r as n}from"./react-vendor-NlGWQ5oO.js";import{s as l}from"./index-BMnqOaA5.js";import"./supabase-vendor-DmmNYjRx.js";const ae=()=>{const N=X(),[o,C]=n.useState(null),[M,E]=n.useState(!0),[h,d]=n.useState(!1),[f,S]=n.useState(!1),[P,r]=n.useState(null),[_,U]=n.useState(null),[b,k]=n.useState(""),[u,$]=n.useState(""),[F,g]=n.useState(null),[m,z]=n.useState(null),[v,w]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const{data:{user:s},error:t}=await l.auth.getUser();if(t||!s){N("/");return}const{data:c,error:x}=await l.from("profiles").select("id, username, full_name, email, avatar_url, role").eq("id",s.id).single();if(x){r("Failed to load profile"),E(!1);return}c&&(C(c),k(c.full_name||""),$(c.username||""),g(c.avatar_url||null),w(!1))}catch{r("An unexpected error occurred")}finally{E(!1)}})()},[N]);const D=a=>["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(a.type)?a.size>5242880?(r("Image size must be less than 5MB"),!1):!0:(r("Please select a valid image file (JPEG, PNG, GIF, or WebP)"),!1),q=a=>{const s=a.target.files?.[0];if(!s||!D(s))return;z(s),w(!1),r(null);const t=new FileReader;t.onloadend=()=>{g(t.result)},t.readAsDataURL(s)},G=async a=>{const{data:{user:s}}=await l.auth.getUser();if(!s)throw new Error("You must be logged in to upload files");try{const{data:j}=await l.storage.from("avatar").list(s.id);if(j&&j.length>0){const A=j.map(Y=>`${s.id}/${Y.name}`);await l.storage.from("avatar").remove(A)}}catch{}const t=a.name.split(".").pop(),c=`${Date.now()}-${Math.random().toString(36).substring(2)}.${t}`,x=`${s.id}/${c}`,{error:i}=await l.storage.from("avatar").upload(x,a,{cacheControl:"3600",upsert:!1});if(i)throw i;const{data:p}=l.storage.from("avatar").getPublicUrl(x);return p.publicUrl},I=async()=>{d(!0),r(null),U(null);try{const{data:{user:a}}=await l.auth.getUser();if(!a){r("You must be logged in to save changes"),d(!1);return}if(!u.trim()){r("Username is required"),d(!1);return}if(u.trim().length<3){r("Username must be at least 3 characters long"),d(!1);return}if(!/^[a-zA-Z0-9_]+$/.test(u.trim())){r("Username can only contain letters, numbers, and underscores"),d(!1);return}if(u.trim()!==o?.username){const{data:i}=await l.from("profiles").select("id").eq("username",u.trim()).neq("id",a.id).single();if(i){r("Username is already taken. Please choose a different one."),d(!1);return}}let t=o?.avatar_url;if(v)try{const{data:{user:i}}=await l.auth.getUser();if(i){const{data:p}=await l.storage.from("avatar").list(i.id);if(p&&p.length>0){const j=p.map(A=>`${i.id}/${A.name}`);await l.storage.from("avatar").remove(j)}}t=null,w(!1)}catch{}else if(m){S(!0);try{t=await G(m),z(null)}catch(i){const p=i instanceof Error?i.message:"Failed to upload avatar";r(p),S(!1),d(!1);return}S(!1)}const{error:c}=await l.from("profiles").update({username:u.trim(),full_name:b.trim()||null,avatar_url:t||null,updated_at:new Date().toISOString()}).eq("id",a.id);if(c){r(c.message||"Failed to update profile"),d(!1);return}U("Profile updated successfully!");const x={...o,username:u.trim(),full_name:b.trim()||null,avatar_url:t||null};C(x),g(v?null:t||null),setTimeout(()=>{U(null)},3e3)}catch(a){const s=a instanceof Error?a.message:"An unexpected error occurred";r(s)}finally{d(!1)}},T=async()=>{z(null),g(null),w(!0),r(null)},B=a=>a.split(" ").map(s=>s[0]).join("").toUpperCase().slice(0,2);return M?e.jsx("div",{className:"settings-page",children:e.jsxs("div",{className:"settings-loading",children:[e.jsx(R,{className:"loading-spinner",size:48}),e.jsx("p",{children:"Loading settings..."})]})}):o?e.jsx("div",{className:"settings-page",children:e.jsxs("div",{className:"settings-container",children:[e.jsxs("div",{className:"settings-header",children:[e.jsx("button",{className:"back-button",onClick:()=>N(-1),"aria-label":"Go back",children:e.jsx(Z,{size:20})}),e.jsxs("div",{className:"header-content",children:[e.jsx("h1",{children:"Settings"}),e.jsx("p",{children:"Manage your profile and preferences"})]})]}),P&&e.jsxs("div",{className:"alert alert-error",children:[e.jsx(L,{size:20}),e.jsx("span",{children:P})]}),_&&e.jsxs("div",{className:"alert alert-success",children:[e.jsx(H,{size:20}),e.jsx("span",{children:_})]}),e.jsxs("div",{className:"settings-content",children:[e.jsxs("div",{className:"settings-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"Profile Picture"}),e.jsx("p",{children:"Upload a new avatar image (max 5MB)"})]}),e.jsxs("div",{className:"avatar-upload-section",children:[e.jsx("div",{className:"avatar-preview-container",children:F&&!v?e.jsxs("div",{className:"avatar-preview-wrapper",children:[e.jsx("img",{src:F,alt:"Avatar preview",className:"avatar-preview"}),e.jsx("button",{className:"remove-avatar-btn",onClick:T,"aria-label":"Remove avatar",title:"Remove avatar",children:e.jsx(J,{size:16})})]}):e.jsx("div",{className:"avatar-placeholder",children:o.full_name||o.username?e.jsx("span",{className:"avatar-initials",children:B(o.full_name||o.username)}):e.jsx(y,{size:48})})}),e.jsxs("div",{className:"upload-controls",children:[e.jsxs("label",{htmlFor:"avatar-upload",className:"upload-button",children:[e.jsx(O,{size:20}),e.jsx("span",{children:F&&!v||m?"Change Avatar":"Upload Avatar"}),e.jsx("input",{id:"avatar-upload",type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:q,className:"file-input",disabled:h||f})]}),m&&e.jsxs("p",{className:"file-info",children:["Selected: ",m.name," (",(m.size/1024/1024).toFixed(2)," MB)"]}),v&&!m&&e.jsx("p",{className:"file-info",style:{color:"var(--color-error)"},children:"Avatar will be removed when you save"})]})]})]}),e.jsxs("div",{className:"settings-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"Profile Information"}),e.jsx("p",{children:"Update your personal information"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"username",children:[e.jsx(y,{size:18}),"Username"]}),e.jsx("input",{id:"username",type:"text",value:u,onChange:a=>$(a.target.value),placeholder:"Enter your username",className:"form-input",disabled:h||f}),e.jsx("p",{className:"form-hint",children:"Username must be at least 3 characters and can only contain letters, numbers, and underscores."})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"fullName",children:[e.jsx(y,{size:18}),"Full Name"]}),e.jsx("input",{id:"fullName",type:"text",value:b,onChange:a=>k(a.target.value),placeholder:"Enter your full name",className:"form-input",disabled:h||f}),e.jsx("p",{className:"form-hint",children:"Your display name (optional)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"email",children:[e.jsx(y,{size:18}),"Email"]}),e.jsx("input",{id:"email",type:"email",value:o.email||"",placeholder:"Email address",className:"form-input",disabled:!0}),e.jsx("p",{className:"form-hint",children:"Email cannot be changed from here. Contact support if you need to change it."})]})]}),e.jsxs("div",{className:"settings-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>N(-1),disabled:h||f,children:"Cancel"}),e.jsx("button",{className:"btn-primary",onClick:I,disabled:h||f||u.trim()===o.username&&b.trim()===(o.full_name||"")&&!m&&!v,children:h||f?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"spinner",size:20}),f?"Uploading...":"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{size:20}),"Save Changes"]})})]})]})]})}):e.jsx("div",{className:"settings-page",children:e.jsxs("div",{className:"settings-error",children:[e.jsx(L,{size:48}),e.jsx("p",{children:"Failed to load profile"}),e.jsx("button",{onClick:()=>N("/"),className:"btn-primary",children:"Go Home"})]})})};export{ae as default};
